<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEARL Agent - Agentic Career Mentor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .navbar-brand {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .navbar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-nav {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-signin {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-signin:hover {
            background: #667eea;
            color: white;
        }

        .btn-signup {
            background: #667eea;
            color: white;
        }

        .btn-signup:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .user-menu:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .dropdown-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }

        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }

        .modal-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .skill-chip {
            display: inline-block;
            background: #e0e7ff;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .module-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .module-card:hover:not(.locked) {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .module-card.completed {
            border-left-color: #48bb78;
            background: #f0fdf4;
        }

        .module-card.active {
            border-left-color: #ed8936;
            background: #fffbf0;
        }

        .module-card.locked {
            border-left-color: #cbd5e0;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #fef2f2;
            color: #7f1d1d;
            border: 1px solid #fecaca;
        }

        .alert-success {
            background: #f0fdf4;
            color: #065f46;
            border: 1px solid #bbf7d0;
        }

        .action-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .action-box:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .action-box.completed {
            background: #f0fdf4;
            border-color: #48bb78;
        }

        .action-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .badge-byte {
            background: #e0e7ff;
            color: #667eea;
        }

        .badge-course {
            background: #dbeafe;
            color: #0369a1;
        }

        .badge-taiken {
            background: #fce7f3;
            color: #be185d;
        }

        .badge-checkpoint {
            background: #fef08a;
            color: #854d0e;
        }

        .breadcrumb {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            color: #667eea;
        }

        .breadcrumb-item::after {
            content: "‚Üí";
            margin: 0 10px;
        }

        .breadcrumb-item:last-child::after {
            content: "";
            margin: 0;
        }

        .breadcrumb-item.active {
            color: #667eea;
            font-weight: 600;
            cursor: default;
        }

        .quiz-question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quiz-option {
            background: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .quiz-option.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .quiz-option.correct {
            border-color: #48bb78;
            background: #f0fdf4;
        }

        .quiz-option.incorrect {
            border-color: #f56565;
            background: #fef2f2;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #999;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            padding: 0 15px;
        }

        .link-text {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .link-text a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .link-text a:hover {
            text-decoration: underline;
        }

        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-oauth {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-oauth:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
        }

        .profile-info h2 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .profile-info .bio {
            color: #666;
            margin: 10px 0;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .skill-gap-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .skill-name {
            font-weight: 600;
            color: #333;
        }

        .skill-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar-small {
            width: 150px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .skill-level {
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <div class="navbar">
            <div class="navbar-brand" onclick="backToHome()">üéì PEARL Agent</div>
            <div class="navbar-actions" id="navbarActions"></div>
        </div>

        <!-- Sign In Modal -->
        <div id="signinModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('signinModal')">&times;</span>
                <h2 class="modal-title">Welcome Back</h2>
                <p class="modal-subtitle">Sign in to continue your learning journey</p>
                <div id="signinError" class="alert alert-error" style="display: none;"></div>
                <div class="input-group">
                    <label for="signinEmail">Email</label>
                    <input type="email" id="signinEmail" placeholder="you@example.com">
                </div>
                <div class="input-group">
                    <label for="signinPassword">Password</label>
                    <input type="password" id="signinPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn-primary" onclick="signIn()" style="width: 100%;">Sign In</button>
                <div class="divider"><span>or</span></div>
                <div class="oauth-buttons">
                    <button class="btn-oauth" onclick="signInOAuth('google')">
                        <span>üîµ</span> Continue with Google
                    </button>
                    <button class="btn-oauth" onclick="signInOAuth('github')">
                        <span>‚ö´</span> Continue with GitHub
                    </button>
                </div>
                <div class="link-text">
                    Don't have an account? <a onclick="switchModal('signinModal', 'signupModal')">Sign up</a>
                </div>
            </div>
        </div>

        <!-- Sign Up Modal -->
        <div id="signupModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('signupModal')">&times;</span>
                <h2 class="modal-title">Create Account</h2>
                <p class="modal-subtitle">Start your personalized learning path</p>
                <div id="signupError" class="alert alert-error" style="display: none;"></div>
                <div class="input-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" placeholder="johndoe">
                </div>
                <div class="input-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="you@example.com">
                </div>
                <div class="input-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn-primary" onclick="signUp()" style="width: 100%;">Create Account</button>
                <div class="divider"><span>or</span></div>
                <div class="oauth-buttons">
                    <button class="btn-oauth" onclick="signInOAuth('google')">
                        <span>üîµ</span> Continue with Google
                    </button>
                    <button class="btn-oauth" onclick="signInOAuth('github')">
                        <span>‚ö´</span> Continue with GitHub
                    </button>
                </div>
                <div class="link-text">
                    Already have an account? <a onclick="switchModal('signupModal', 'signinModal')">Sign in</a>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="card section">
            <button class="btn-secondary" onclick="backToHome()" style="margin-bottom: 20px;">‚Üê Back to Home</button>

            <div class="profile-header">
                <img id="profileAvatar" class="profile-avatar-large" src="https://via.placeholder.com/120" alt="Profile">
                <div class="profile-info">
                    <h2 id="profileUsername">Loading...</h2>
                    <div class="bio" id="profileBio"></div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="profileStreak">0</span>
                            <span class="stat-label">Day Streak</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="profileFollowers">0</span>
                            <span class="stat-label">Followers</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="profileFollowing">0</span>
                            <span class="stat-label">Following</span>
                        </div>
                    </div>
                </div>
            </div>

            <h3>üìä Skill Gap Analysis</h3>
            <div class="skill-gap-card">
                <div class="stats-grid" id="gapAnalysisStats"></div>
                <div id="skillGapList"></div>
            </div>

            <h3>üéØ Active Learning Paths</h3>
            <div id="activeSessionsList"></div>
        </div>

        <!-- Goal Input Section -->
        <div id="goalSection" class="card section active">
            <h2>Start Your Learning Journey</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter your career goal or paste a job description to get personalized learning modules.</p>
            <div class="input-group">
                <label for="careerGoal">Career Goal</label>
                <input type="text" id="careerGoal" placeholder="e.g., Become a Backend Developer, Become a Singer">
            </div>
            <div class="input-group">
                <label for="jobDesc">Job Description (Optional)</label>
                <textarea id="jobDesc" placeholder="Paste a job description for more personalized recommendations..."></textarea>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="startJourney()">üöÄ Start Journey</button>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="card section">
            <div class="loading">
                <div class="spinner"></div>
                <p>Analyzing your goal and creating personalized modules...</p>
            </div>
        </div>

        <!-- Journey Overview Section -->
        <div id="journeySection" class="card section">
            <h2 id="journeyTitle">Learning Path</h2>
            <div style="margin: 20px 0;">
                <h3 style="margin-bottom: 15px;">üìö Skills to Master</h3>
                <div id="skillsList"></div>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="totalModulesCount">0</div>
                    <div class="stat-label">Total Modules</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalHoursCount">0</div>
                    <div class="stat-label">Hours to Complete</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="progressCount">0%</div>
                    <div class="stat-label">Overall Progress</div>
                </div>
            </div>
            <h3 style="margin-top: 30px; margin-bottom: 15px;">üìñ Learning Modules</h3>
            <div id="modulesList"></div>
        </div>

        <!-- Module Detail Section -->
        <div id="moduleDetailSection" class="card section">
            <button class="btn-secondary" onclick="backToJourney()" style="margin-bottom: 20px;">‚Üê Back to Modules</button>
            <div class="breadcrumb">
                <div class="breadcrumb-item" onclick="backToJourney()">Skills</div>
                <div class="breadcrumb-item" id="currentSkillBreadcrumb">Skill</div>
                <div class="breadcrumb-item active" id="currentModuleBreadcrumb">Module</div>
            </div>
            <h2 id="moduleTitle">Module Title</h2>
            <p id="moduleDescription" style="color: #666; margin: 15px 0;"></p>
            <h3 style="margin: 25px 0 15px 0;">üìã Learning Objectives</h3>
            <ul id="objectivesList" style="margin-left: 20px; color: #666;"></ul>
            <h3 style="margin: 25px 0 15px 0;">‚úÖ Actions to Complete</h3>
            <div id="actionsList"></div>
            <div class="button-group" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="backToJourney()">‚Üê Back</button>
                <button class="btn-primary" onclick="nextModule()" id="nextModuleBtn">Next Module ‚Üí</button>
            </div>
        </div>

        <!-- Checkpoint Modal -->
        <div id="checkpointModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('checkpointModal')">&times;</span>
                <h2 class="modal-title">üìù Module Checkpoint</h2>
                <p class="modal-subtitle">Answer these questions to unlock the next module</p>
                <div id="checkpointQuestions"></div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="closeModal('checkpointModal')">Cancel</button>
                    <button class="btn-primary" onclick="submitCheckpoint()" id="submitCheckpointBtn">Submit Answers</button>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="resultsModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('resultsModal')">&times;</span>
                <h2 class="modal-title" id="resultsTitle">Results</h2>
                <div id="resultsContent"></div>
                <button class="btn-primary" onclick="closeModal('resultsModal')" style="width: 100%; margin-top: 20px;">Continue</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        let authToken = null;
        let currentSessionId = null;
        let currentSkill = null;
        let currentModule = null;
        let learningPaths = {};
        let currentModuleData = null;
        let checkpointAnswers = [];

        window.onload = function() {
            checkAuthState();
        };

        function checkAuthState() {
            authToken = localStorage.getItem('auth_token');
            const userDataStr = localStorage.getItem('user_data');
            
            if (authToken && userDataStr) {
                currentUser = JSON.parse(userDataStr);
                updateNavbar(true);
            } else {
                updateNavbar(false);
            }
        }

        function updateNavbar(isLoggedIn) {
            const navbarActions = document.getElementById('navbarActions');
            
            if (isLoggedIn && currentUser) {
                navbarActions.innerHTML = `
                    <div class="user-menu" onclick="toggleUserMenu(event)">
                        <img class="user-avatar" src="${currentUser.profile?.profile_pic || 'https://via.placeholder.com/40'}" alt="User">
                        <span class="user-name">${currentUser.username || 'User'}</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" onclick="viewProfile()">üë§ Profile</div>
                        <div class="dropdown-item" onclick="signOut()">üö™ Sign Out</div>
                    </div>
                `;
            } else {
                navbarActions.innerHTML = `
                    <button class="btn-nav btn-signin" onclick="openModal('signinModal')">Sign In</button>
                    <button class="btn-nav btn-signup" onclick="openModal('signupModal')">Sign Up</button>
                `;
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown && !event.target.closest('.user-menu')) {
                dropdown.classList.remove('active');
            }
        });

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function switchModal(closeId, openId) {
            closeModal(closeId);
            openModal(openId);
        }

        async function signUp() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!username || !email || !password) {
                showError('signupError', 'Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('auth_token', data.access_token);
                    localStorage.setItem('user_data', JSON.stringify(data.user));
                    currentUser = data.user;
                    authToken = data.access_token;
                    
                    closeModal('signupModal');
                    updateNavbar(true);
                    alert('Account created successfully! üéâ');
                } else {
                    showError('signupError', data.detail || 'Sign up failed');
                }
            } catch (error) {
                console.error('Sign up error:', error);
                showError('signupError', 'Sign up failed. Please try again.');
            }
        }

        async function signIn() {
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            
            if (!email || !password) {
                showError('signinError', 'Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('auth_token', data.access_token);
                    localStorage.setItem('user_data', JSON.stringify(data.user));
                    currentUser = data.user;
                    authToken = data.access_token;
                    
                    closeModal('signinModal');
                    updateNavbar(true);
                    alert('Welcome back! üëã');
                } else {
                    showError('signinError', data.detail || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Sign in error:', error);
                showError('signinError', 'Sign in failed. Please try again.');
            }
        }

        async function signInOAuth(provider) {
            alert('OAuth sign in coming soon!');
        }

        async function signOut() {
            try {
                await fetch(`${API_URL}/auth/signout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
            } catch (error) {
                console.error('Sign out error:', error);
            }
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            currentUser = null;
            authToken = null;
            
            updateNavbar(false);
            showSection('goalSection');
            alert('Signed out successfully');
        }

        async function viewProfile() {
            if (!currentUser || !currentUser.id) {
                alert('Please sign in first');
                return;
            }
            
            try {
                // Get full profile with skills
                const response = await fetch(`${API_URL}/auth/profile/${currentUser.id}`);
                const data = await response.json();
                
                // Update profile UI
                document.getElementById('profileAvatar').src = data.profile?.profile_pic || 'https://via.placeholder.com/120';
                document.getElementById('profileUsername').textContent = data.profile?.username || 'User';
                document.getElementById('profileBio').textContent = data.profile?.bio || 'No bio yet';
                document.getElementById('profileStreak').textContent = data.profile?.streak_count || 0;
                document.getElementById('profileFollowers').textContent = data.profile?.followers_count || 0;
                document.getElementById('profileFollowing').textContent = data.profile?.following_count || 0;
                
                // Get skill gap analysis
                const gapResponse = await fetch(`${API_URL}/auth/profile/${currentUser.id}/skill-gap`);
                const gapData = await gapResponse.json();
                
                displaySkillGapAnalysis(gapData);
                displayActiveSessions(data.active_sessions);
                
                showSection('profileSection');
            } catch (error) {
                console.error('Profile load error:', error);
                alert('Failed to load profile');
            }
        }

        function displaySkillGapAnalysis(data) {
            const statsHtml = `
                <div class="stat-box">
                    <div class="stat-value">${data.overall_readiness || 0}%</div>
                    <div class="stat-label">Overall Readiness</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.skills_mastered || 0}</div>
                    <div class="stat-label">Skills Mastered</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.skills_in_progress || 0}</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.skills_to_learn || 0}</div>
                    <div class="stat-label">To Learn</div>
                </div>
            `;
            document.getElementById('gapAnalysisStats').innerHTML = statsHtml;
            
            // Display individual skills
            let skillsHtml = '<h4 style="margin: 20px 0 10px 0;">Skills Progress</h4>';
            
            for (const [skill, details] of Object.entries(data.required_skills || {})) {
                const percentage = (details.current_level * 100).toFixed(0);
                skillsHtml += `
                    <div class="skill-item">
                        <div class="skill-name">${skill}</div>
                        <div class="skill-progress">
                            <div class="progress-bar-small">
                                <div class="progress-fill-small" style="width: ${percentage}%"></div>
                            </div>
                            <span class="skill-level">${percentage}%</span>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('skillGapList').innerHTML = skillsHtml;
        }

        function displayActiveSessions(sessions) {
            if (!sessions || sessions.length === 0) {
                document.getElementById('activeSessionsList').innerHTML = '<p style="color: #999;">No active learning paths yet. Start a journey to begin!</p>';
                return;
            }
            
            let html = '';
            sessions.forEach(session => {
                const parsed = session.jd_parsed || {};
                const paths = parsed.learning_paths || {};
                const skillCount = Object.keys(paths).length;
                
                html += `
                    <div class="module-card active" onclick="loadSession('${session.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 5px;">
                                    ${session.jd_text?.substring(0, 50) || 'Learning Journey'}...
                                </div>
                                <div style="color: #666; font-size: 0.9em;">
                                    ${skillCount} skills ‚Ä¢ Started ${new Date(session.created_at).toLocaleDateString()}
                                </div>
                            </div>
                            <button class="btn-primary" onclick="loadSession('${session.id}'); event.stopPropagation();">
                                Continue ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('activeSessionsList').innerHTML = html;
        }

        function loadSession(sessionId) {
            currentSessionId = sessionId;
            fetch(`${API_URL}/agent/current-action/${sessionId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.learning_path) {
                        learningPaths = data.learning_path.learning_paths || {};
                        displayJourney({
                            target_role: data.current_skill || 'Learning Path',
                            skills_to_learn: Object.keys(learningPaths),
                            learning_paths: learningPaths
                        });
                    }
                })
                .catch(err => console.error('Load session error:', err));
        }

        function backToHome() {
            showSection('goalSection');
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        async function startJourney() {
            const goal = document.getElementById('careerGoal').value;
            const jdText = document.getElementById('jobDesc').value;
            
            if (!goal.trim()) {
                alert('Please enter a career goal');
                return;
            }
            
            if (!currentUser) {
                alert('Please sign in to start your learning journey');
                openModal('signinModal');
                return;
            }
            
            showSection('loadingSection');
            
            try {
                const response = await fetch(`${API_URL}/agent/start-journey`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        goal: goal,
                        jd_text: jdText || null,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                currentSessionId = data.session_id;
                learningPaths = data.learning_paths;
                
                displayJourney(data);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to start journey. Please try again.');
                showSection('goalSection');
            }
        }

        function displayJourney(data) {
            document.getElementById('journeyTitle').textContent = data.target_role;
            
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = data.skills_to_learn
                .map(skill => `<span class="skill-chip">${skill}</span>`)
                .join('');
            
            let totalModules = 0;
            let totalHours = 0;
            let completedModules = 0;
            
            for (const skill in learningPaths) {
                const path = learningPaths[skill];
                totalModules += path.total_modules;
                totalHours += path.estimated_hours;
                
                path.modules.forEach(module => {
                    if (module.status === 'completed') completedModules++;
                });
            }
            
            const progress = totalModules > 0 ? (completedModules / totalModules * 100) : 0;
            
            document.getElementById('totalModulesCount').textContent = totalModules;
            document.getElementById('totalHoursCount').textContent = totalHours;
            document.getElementById('progressCount').textContent = progress.toFixed(0) + '%';
            
            displayModulesList();
            showSection('journeySection');
        }

        function displayModulesList() {
            const modulesList = document.getElementById('modulesList');
            let html = '';
            
            for (const skill in learningPaths) {
                const path = learningPaths[skill];
                html += `<h4 style="margin-top: 20px; color: #667eea;">${skill}</h4>`;
                
                path.modules.forEach(module => {
                    const completedActions = module.actions.filter(a => a.completed).length;
                    const totalActions = module.actions.length;
                    const progress = totalActions > 0 ? (completedActions / totalActions * 100) : 0;
                    const statusClass = module.status;
                    const isClickable = statusClass !== 'locked';
                    
                    html += `
                        <div class="module-card ${statusClass}" ${isClickable ? `onclick="openModule('${skill}', ${module.module_id})"` : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 5px;">${module.name}</div>
                                    <div style="color: #666; font-size: 0.9em; margin-bottom: 10px;">${module.description}</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 0.85em; color: #999;">
                                        ${completedActions}/${totalActions} actions completed
                                    </div>
                                </div>
                                <div style="margin-left: 20px;">
                                    <span style="text-transform: capitalize; font-size: 0.85em; padding: 6px 12px; background: rgba(0,0,0,0.1); border-radius: 20px;">
                                        ${statusClass}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            modulesList.innerHTML = html;
        }

        function openModule(skill, moduleId) {
            currentSkill = skill;
            const path = learningPaths[skill];
            const module = path.modules.find(m => m.module_id === moduleId);
            
            if (!module || module.status === 'locked') {
                return;
            }
            
            currentModule = moduleId;
            currentModuleData = module;
            
            document.getElementById('currentSkillBreadcrumb').textContent = skill;
            document.getElementById('currentModuleBreadcrumb').textContent = module.name;
            document.getElementById('moduleTitle').textContent = module.name;
            document.getElementById('moduleDescription').textContent = module.description;
            
            const objectivesList = document.getElementById('objectivesList');
            objectivesList.innerHTML = module.learning_objectives
                .map(obj => `<li style="margin-bottom: 8px;">${obj}</li>`)
                .join('');
            
            displayActions(module);
            showSection('moduleDetailSection');
        }

        function displayActions(module) {
            const actionsList = document.getElementById('actionsList');
            let html = '';
            
            module.actions.forEach((action, index) => {
                const isCompleted = action.completed || false;
                const badgeType = `badge-${action.type}`;
                const icon = {
                    'byte': 'üì±',
                    'course': 'üìö',
                    'taiken': '‚ö°',
                    'checkpoint': '‚úÖ'
                }[action.type] || 'üìù';
                
                html += `
                    <div class="action-box ${isCompleted ? 'completed' : ''}">
                        <span class="action-type-badge ${badgeType}">${icon} ${action.type.toUpperCase()}</span>
                        <h4 style="margin-bottom: 10px;">${action.title}</h4>
                        <p style="color: #666; margin-bottom: 15px;">${action.description}</p>
                        
                        ${action.platform ? `<p style="font-size: 0.9em; color: #999; margin-bottom: 10px;">üìç Platform: ${action.platform}</p>` : ''}
                        ${action.duration_minutes ? `<p style="font-size: 0.9em; color: #999; margin-bottom: 10px;">‚è±Ô∏è Duration: ${action.duration_minutes} minutes</p>` : ''}
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            ${action.url && action.type !== 'checkpoint' ? `
                                <a href="${action.url}" target="_blank" style="flex: 1;">
                                    <button class="btn-secondary" style="width: 100%;">üîó Open Resource</button>
                                </a>
                            ` : ''}
                            
                            ${!isCompleted ? `
                                <button class="btn-success" style="flex: 1;" onclick="completeAction('${currentSkill}', ${module.module_id}, ${index}, '${action.type}')">
                                    ${action.type === 'checkpoint' ? 'üìù Take Quiz' : '‚úì Mark Complete'}
                                </button>
                            ` : `
                                <button class="btn-primary" style="flex: 1;" disabled>
                                    ‚úì Completed
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            actionsList.innerHTML = html;
        }

        async function completeAction(skill, moduleId, actionIndex, actionType) {
            if (actionType === 'checkpoint') {
                openCheckpoint(skill, moduleId, actionIndex);
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/agent/complete-action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        skill: skill,
                        module_id: moduleId,
                        action_index: actionIndex,
                        completion_data: { action_type: actionType },
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local state
                    const module = learningPaths[skill].modules.find(m => m.module_id === moduleId);
                    module.actions[actionIndex].completed = true;
                    
                    // Refresh display
                    displayActions(module);
                    displayModulesList();
                    
                    // Check if module is complete
                    const allComplete = module.actions.every(a => a.completed);
                    if (allComplete) {
                        module.status = 'completed';
                        
                        // Unlock next module
                        if (moduleId < learningPaths[skill].total_modules) {
                            learningPaths[skill].modules[moduleId].status = 'active';
                        }
                        
                        displayModulesList();
                        
                        showResultsModal('üéâ Module Complete!', `
                            <p style="font-size: 1.2em; margin-bottom: 20px;">Great job! You've completed all actions in this module.</p>
                            ${moduleId < learningPaths[skill].total_modules ? 
                                '<p style="color: #667eea;">The next module has been unlocked!</p>' : 
                                '<p style="color: #48bb78;">You\'ve completed this skill! üöÄ</p>'}
                        `);
                    } else {
                        alert('Action completed! ‚úì');
                    }
                }
            } catch (error) {
                console.error('Error completing action:', error);
                alert('Failed to mark action as complete. Please try again.');
            }
        }

        function openCheckpoint(skill, moduleId, actionIndex) {
            const module = learningPaths[skill].modules.find(m => m.module_id === moduleId);
            const checkpoint = module.actions[actionIndex];
            
            if (!checkpoint.questions || checkpoint.questions.length === 0) {
                alert('No questions available for this checkpoint.');
                return;
            }
            
            checkpointAnswers = new Array(checkpoint.questions.length).fill(-1);
            
            const questionsHtml = checkpoint.questions.map((q, qIndex) => `
                <div class="quiz-question">
                    <h4 style="margin-bottom: 15px;">Question ${qIndex + 1}</h4>
                    <p style="margin-bottom: 15px; font-weight: 500;">${q.question}</p>
                    ${q.options.map((option, oIndex) => `
                        <div class="quiz-option" onclick="selectOption(${qIndex}, ${oIndex})">
                            <input type="radio" name="q${qIndex}" id="q${qIndex}_${oIndex}" style="margin-right: 10px;">
                            <label for="q${qIndex}_${oIndex}" style="cursor: pointer;">${option}</label>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            document.getElementById('checkpointQuestions').innerHTML = questionsHtml;
            
            // Store current checkpoint context
            window.currentCheckpoint = { skill, moduleId, actionIndex };
            
            openModal('checkpointModal');
        }

        function selectOption(questionIndex, optionIndex) {
            checkpointAnswers[questionIndex] = optionIndex;
            
            // Visual feedback
            const options = document.querySelectorAll(`input[name="q${questionIndex}"]`);
            options.forEach((opt, idx) => {
                const parent = opt.closest('.quiz-option');
                parent.classList.toggle('selected', idx === optionIndex);
                opt.checked = idx === optionIndex;
            });
            
            // Enable submit button if all answered
            const allAnswered = checkpointAnswers.every(a => a !== -1);
            document.getElementById('submitCheckpointBtn').disabled = !allAnswered;
        }

        async function submitCheckpoint() {
            const { skill, moduleId, actionIndex } = window.currentCheckpoint;
            
            const allAnswered = checkpointAnswers.every(a => a !== -1);
            if (!allAnswered) {
                alert('Please answer all questions before submitting.');
                return;
            }
            
            closeModal('checkpointModal');
            
            try {
                const response = await fetch(`${API_URL}/agent/submit-checkpoint`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        skill: skill,
                        module_id: moduleId,
                        answers: checkpointAnswers,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                const result = data.checkpoint_result;
                
                if (result.passed) {
                    // Update local state
                    const module = learningPaths[skill].modules.find(m => m.module_id === moduleId);
                    module.actions[actionIndex].completed = true;
                    module.status = 'completed';
                    
                    // Unlock next module
                    if (moduleId < learningPaths[skill].total_modules) {
                        learningPaths[skill].modules[moduleId].status = 'active';
                    }
                    
                    displayActions(module);
                    displayModulesList();
                    
                    showResultsModal('‚úÖ Checkpoint Passed!', `
                        <div style="text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 20px;">üéâ</div>
                            <p style="font-size: 1.3em; font-weight: 600; margin-bottom: 10px;">Score: ${result.score.toFixed(0)}%</p>
                            <p style="color: #666; margin-bottom: 20px;">You got ${result.correct_count} out of ${result.total_questions} correct!</p>
                            <p style="color: #48bb78; font-weight: 600;">${result.message}</p>
                        </div>
                    `);
                } else {
                    showResultsModal('‚ùå Checkpoint Not Passed', `
                        <div style="text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 20px;">üìö</div>
                            <p style="font-size: 1.3em; font-weight: 600; margin-bottom: 10px;">Score: ${result.score.toFixed(0)}%</p>
                            <p style="color: #666; margin-bottom: 20px;">You got ${result.correct_count} out of ${result.total_questions} correct.</p>
                            <p style="color: #f56565; font-weight: 600;">You need ${result.pass_threshold}% to pass. Review the material and try again!</p>
                        </div>
                    `);
                }
            } catch (error) {
                console.error('Error submitting checkpoint:', error);
                alert('Failed to submit checkpoint. Please try again.');
            }
        }

        function showResultsModal(title, content) {
            document.getElementById('resultsTitle').textContent = title;
            document.getElementById('resultsContent').innerHTML = content;
            openModal('resultsModal');
        }

        function backToJourney() {
            displayModulesList();
            showSection('journeySection');
        }

        function nextModule() {
            if (!currentSkill || !currentModule) return;
            
            const path = learningPaths[currentSkill];
            const nextModuleId = currentModule + 1;
            
            if (nextModuleId <= path.total_modules) {
                const nextModule = path.modules.find(m => m.module_id === nextModuleId);
                if (nextModule && nextModule.status !== 'locked') {
                    openModule(currentSkill, nextModuleId);
                } else {
                    alert('Complete the current module to unlock the next one!');
                }
            } else {
                alert('This is the last module in this skill! üéâ');
                backToJourney();
            }
        }
    </script>
</body>
</html>